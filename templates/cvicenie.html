{% extends "base.html" %}
{% block title %}Cvi캜enie{% endblock %}

{% block content %}
<main class="container py-3">

  {% if is_preview %}
    <div class="alert alert-info">Toto je n치h쬬d tvojho cvi캜enia. Nezabudni ho publikova콘.</div>
  {% endif %}

  <div class="mb-4">
    <h1 class="h3">{{ exercise.title }}</h1>
    <p class="text-muted mb-1">
      Kateg칩ria:
      <span class="badge bg-secondary">
        <i class="{{ category_icon }} me-1"></i>{{ exercise.category }} / {{ exercise.subcategory }}
      </span>
    </p>
    <div class="d-flex align-items-center mb-1">
      <span class="text-muted me-2">Autor: </span>
      <img src="{{ url_for('static', filename='uploads/profiles/' ~ author.photo) }}" alt="{{ author.name }}" width="22" height="22" class="rounded-circle me-1">
      <strong class="text-muted">{{ author.name }}</strong>
    </div>
<p class="mb-2">
  {{ exercise.full_description }} <a href="#" id="toggleKeywords" class="ms-2 link-primary small">Zobrazi콘 k쮂줷꼂v칠 hodnoty</a>
    </p>
    <div id="keywordsBox" class="mt-2 d-none small">
      <span class="badge bg-pink text-white me-1">self</span>
      <span class="badge bg-pink text-white me-1">super</span>
      <span class="badge bg-pink text-white me-1">class</span>
      <span class="badge bg-pink text-white me-1">print</span>
      <span class="badge bg-pink text-white me-1">Zviera</span>
      <span class="badge bg-pink text-white me-1">zvuk</span>
    </div>
  </div>

  <div class="mb-4">
    <div id="modeButtons" class="rounded-pill bg-light d-inline-flex shadow-sm p-1" style="gap: 2px;">
      <button type="button" class="btn btn-sm rounded-pill px-3 py-1 active" data-mode="fill">
        <i class="fa-regular fa-pen-to-square me-1"></i>Dop컄켿a캜ka
      </button>
      <button type="button" class="btn btn-sm rounded-pill px-3 py-1" data-mode="free">
        <i class="fa-solid fa-terminal me-1"></i>Vo쬹칳 k칩d
      </button>
    </div>
  </div>

  <!-- DOP컃켾A캛KA -->
  <div class="border rounded-4 p-4 bg-light" id="fillMode">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <p class="fw-semibold mb-0">Dopl켿 k쮂줷꼂v칠 slov치 do k칩du:</p>
      <button class="btn btn-outline-secondary btn-sm" id="toggleAnswers">Zobrazi콘 rie코enie</button>
    </div>
    <div class="bg-dark text-white p-3 rounded font-monospace">
      <pre class="mb-0"><code>{{ exercise.code | safe }}</code></pre>
    </div>
    <button class="btn btn-success mt-3">Odosla콘</button>
  </div>

  <!-- VO컇N칗 K칍D -->
  <div class="border rounded-4 p-4 bg-light d-none" id="freeMode">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <p class="fw-semibold mb-0">Nap칤코 vlastn칠 rie코enie:</p>
      <button class="btn btn-outline-secondary btn-sm" id="toggleFreeCode">Zobrazi콘 predpis</button>
    </div>
    <textarea id="freeCodeArea" class="form-control font-monospace bg-dark text-white" rows="12" placeholder="Tu nap칤코 svoj k칩d..."></textarea>
  </div>

  {% if is_preview %}
    <div class="d-flex justify-content-between mt-4">
      <a href="{{ url_for('publish_exercise', id=exercise.id) }}" class="btn btn-success">Publikova콘</a>
      <a href="{{ url_for('edit_exercise', id=exercise.id) }}" class="btn btn-outline-secondary">Upravi콘</a>
    </div>
  {% endif %}
<script>
// 游눠 TU vlo svoj cel칳 JavaScript:
const modeButtons = document.querySelectorAll('#modeButtons button');
const fillMode = document.getElementById('fillMode');
const freeMode = document.getElementById('freeMode');

modeButtons.forEach(button => {
  button.addEventListener('click', () => {
    modeButtons.forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    const selectedMode = button.dataset.mode;
    fillMode.classList.toggle('d-none', selectedMode !== 'fill');
    freeMode.classList.toggle('d-none', selectedMode !== 'free');
  });
});

const toggleAnswersBtn = document.getElementById('toggleAnswers');
let showingAnswers = false;
toggleAnswersBtn.addEventListener('click', () => {
  const inputs = document.querySelectorAll('.code-input');
  showingAnswers = !showingAnswers;
  inputs.forEach(input => {
    if (showingAnswers) {
      if (!input.value || input.value.trim() === '') {
        input.value = input.dataset.answer;
        input.style.color = '#ccc';
      } else {
        input.dataset.userAnswer = input.value;
        input.setAttribute('data-userAnswer', input.value);
        if (input.value !== input.dataset.answer) {
          input.style.color = '#ccc';
          input.value = input.dataset.answer;
        }
      }
    } else {
      const userVal = input.dataset.userAnswer || '';
      input.value = userVal;
      input.style.color = '';
    }
  });
  toggleAnswersBtn.textContent = showingAnswers ? 'Skry콘 rie코enie' : 'Zobrazi콘 rie코enie';
});

const toggleFreeCodeBtn = document.getElementById('toggleFreeCode');
const freeCodeArea = document.getElementById('freeCodeArea');
let showingPreset = false;
const userCode = { content: "" };
const freeTemplate = `class Person:
  def __init__(self, name, age):
    self.name = name
    self.age = age

  def greet(self):
    print("Ahoj, vol치m sa", self.name)

  def birthday(self):
    self.age += 1

class Student(Person):
  def __init__(self, name, age, school):
    super().__init__(name, age)
    self.school = school`;

toggleFreeCodeBtn.addEventListener('click', () => {
  if (!showingPreset) {
    userCode.content = freeCodeArea.value;
    freeCodeArea.value = freeTemplate;
    toggleFreeCodeBtn.textContent = "Skry콘 predpis";
  } else {
    freeCodeArea.value = userCode.content;
    toggleFreeCodeBtn.textContent = "Zobrazi콘 predpis";
  }
  showingPreset = !showingPreset;
});

const checkButton = document.querySelector('#fillMode .btn-success');
checkButton.addEventListener('click', () => {
  const inputs = document.querySelectorAll('.code-input');
  inputs.forEach(input => {
    const userInput = input.value.trim();
    const correctAnswer = input.dataset.answer;
    input.classList.remove('is-valid', 'is-invalid');
    if (userInput.toLowerCase() === correctAnswer.toLowerCase()) {
      input.classList.add('is-valid');
    } else {
      input.classList.add('is-invalid');
    }
  });
});

const toggleKeywordsLink = document.getElementById('toggleKeywords');
const keywordsBox = document.getElementById('keywordsBox');

toggleKeywordsLink.addEventListener('click', (e) => {
  e.preventDefault();
  const inputs = document.querySelectorAll('.code-input');
  const words = [...new Set(Array.from(inputs).map(input => input.dataset.answer.trim()))];

  const highlightWords = ["class", "def", "self", "print", "Zviera", "zvuk"];
  const coloredWords = words.map(word => {
    if (highlightWords.includes(word)) {
      return `<span class="text-pink me-1">${word}</span>`;
    }
    return `<span class="text-muted me-1">${word}</span>`;
  });

  keywordsBox.innerHTML = `V tomto cvi캜en칤 je potrebn칠 doplni콘 k칩d: ${coloredWords.join(' ')}`;
  keywordsBox.classList.toggle('d-none');
  toggleKeywordsLink.textContent = keywordsBox.classList.contains('d-none')
    ? 'Zobrazi콘 k쮂줷꼂v칠 hodnoty'
    : 'Skry콘 k쮂줷꼂v칠 hodnoty';
});

</script>

{% endblock %}