{# templates/projekt-html.html ‚Äî Dynamick√Ω projekt + n√°hƒæad/publik√°cia (FINAL) #}
{% extends "base.html" %}
{% block title %}Projekt{% endblock %}

{% block content %}
<style>
  .proj * { box-sizing: border-box; }
  .proj .pill { border:1px solid #e5e7eb; background:#fff; border-radius:999px; padding:.3rem .6rem; font-size:.8rem; color:#6b7280; }
  .proj .progress-thin { height:8px; background:#f3f4f6; border-radius:999px; overflow:hidden; border:1px solid #e5e7eb; }
  .proj .progress-thin > i { display:block; height:100%; width:0%; background:linear-gradient(90deg,#3b82f6,#22c55e); }

  .proj .steps { list-style:none; padding-left:0; margin:0; }
  .proj .steps li {
    display:flex; align-items:center; gap:.5rem; padding:.55rem .6rem; border-radius:.75rem; cursor:pointer;
    border:1px solid transparent;
  }
  .proj .steps li:hover { background:#f8fafc; }
  .proj .steps li.active { background:#eff6ff; border:1px solid #bfdbfe; }
  .proj .steps li.done   { background:#ecfdf5; border:1px solid #86efac; }
  .proj .steps .idx {
    width:28px; height:28px; display:grid; place-items:center; border-radius:.6rem; border:1px solid #e5e7eb; background:#fff;
    font-weight:700; font-size:.8rem; color:#111827;
  }
  .proj .steps .state { margin-left:auto; font-size:.8rem; color:#16a34a; font-weight:700; }

  .proj details { border:1px dashed #e5e7eb; background:#fafafa; border-radius:.75rem; padding:.6rem .75rem; }
  .proj summary { cursor:pointer; font-weight:700; }

  .proj .card { border-radius:1rem; overflow:hidden; }
  .proj .card-header { background:#fff; }
  .proj .card-header, .proj .card-body { padding:.7rem 1rem; }
  .proj .card-body > :first-child { margin-top:0 !important; }
  .proj .card-body > :last-child  { margin-bottom:0 !important; }

  .proj .hero-left { padding-top:.6rem !important; padding-bottom:.6rem !important; }

  /* code block */
  .proj .code-shell { position:relative; }
  .proj pre.code-block {
    margin:0; padding:1.2rem .48rem .38rem .6rem;
    background:#0f172a; color:#dbeafe; border-radius:.75rem; font-size:.80rem; overflow:auto;
  }
  .proj pre.code-block code {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    white-space: pre; display:block; line-height:1.03;
  }
  .proj .copy-btn {
    position:absolute; top:.28rem; right:.28rem; z-index:2;
    border:1px solid #1f2937; background:#111827; color:#dbeafe;
    border-radius:.4rem; padding:.16rem .42rem; font-size:.72rem;
  }
  .proj .code-line { display:block; padding-left:.5rem; border-left:3px solid transparent; }
  .proj .code-line.added { border-left-color:#22c55e; }

  .proj .muted { color:#6b7280; }

  .lang-badges .badge {
    background:#fff; border:1px solid #e5e7eb; color:#374151; border-radius:999px; padding:.2rem .5rem; display:inline-flex; align-items:center; gap:.4rem;
  }
  .lang-badges .badge img { height:16px; width:auto; }
  .proj .preview-link { font-size:.8rem; }

  .hl-kw{ color:#ec4899; font-weight:800; }
  .proj code.inline{ background:#111827; color:#dbeafe; padding:.05rem .3rem; border-radius:.35rem; }
</style>

<section class="proj">
  <!-- Info bar for PREVIEW -->
  <div id="previewBar" class="alert alert-info d-flex justify-content-between align-items-center d-none">
    <span>Toto je <strong>n√°hƒæad</strong> tvojho projektu. M√¥≈æe≈° ho publikova≈• alebo sa vr√°ti≈• a upravi≈•.</span>
    <span class="d-flex gap-2">
      <button id="btnDoPublish" class="btn btn-success btn-sm">Publikova≈•</button>
      <a id="btnEditBack" href="{{ url_for('projekty_vytvorit') }}" class="btn btn-outline-secondary btn-sm">Upravi≈•</a>
    </span>
  </div>

  <!-- HERO ------------------------------------------------------------------->
  <div class="card shadow-sm mb-3">
    <div class="row g-0 align-items-center">
      <div class="col-12 col-lg-8 hero-left p-2 ps-3 pe-3">
        <div class="d-flex align-items-start gap-3">
          <!-- ikonka projektu -->
          <img id="heroIcon"
            src="{{ url_for('static', filename='project-icons/blackjackicon.png') }}"
            alt="Ikona projektu"
            width="44" height="44"
            style="border-radius:12px; border:1px solid #e5e7eb; object-fit:cover;"
          >
          <div class="flex-grow-1">
            <h1 class="h4 mb-1">Projekt: <strong id="heroTitle">N√°zov</strong></h1>
            <div class="d-flex flex-wrap gap-2 mb-2">
              <span class="pill" id="heroLevel">√örove≈à: ‚Äì</span>
              <span class="pill" id="heroCategory">Kateg√≥ria: ‚Äì</span>
              <span class="pill" id="heroTime" hidden>ƒåas: ‚Äì</span>
            </div>
            <div class="lang-badges d-flex flex-wrap gap-2 mb-1" id="heroLangs"></div>
            <div class="preview-link text-muted" id="heroPreview" hidden>
              <strong>N√°hƒæad:</strong>
              <a id="heroPreviewLink" href="#" target="_blank" rel="noopener"></a>
            </div>
          </div>
        </div>
      </div>
      <!-- Fotka pri n√°zve projektu -->
      <div class="col-12 col-lg-4">
        <div class="ratio ratio-16x9 bg-light d-flex align-items-center justify-content-center">
          <span class="text-muted small">N√°hƒæadov√Ω obr√°zok</span>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <!-- LEFT: kroky + progres -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="fw-semibold">Kroky projektu</div>
          <span class="text-muted small" id="doneCount">0 / 0 hotovo</span>
        </div>
        <div class="card-body">
          <div class="progress-thin mb-3" aria-label="Priebeh">
            <i id="progressBar"></i>
          </div>
          <ul id="steps" class="steps" role="tablist" aria-label="Kroky">
            <li class="text-muted" id="stepsLoading" style="padding:.25rem 0;">Naƒç√≠tavam kroky‚Ä¶</li>
          </ul>
        </div>
      </div>
    </div>

    <!-- RIGHT: Zadanie / Krok / Introspekcia -->
    <div class="col-12 col-lg-8">
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="fw-semibold" id="panelTitle">Zadanie</div>
          <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-soft btn-sm" id="showAssignment">Zobrazi≈• zadanie</button>
            <button class="btn btn-soft btn-sm" id="showIntrospect">Introspekcia</button>
          </div>
        </div>
        <div class="card-body">
          <!-- Zadanie -->
          <div id="assignment">
            <p class="text-muted" id="assignmentText">‚Äî</p>
            <details class="mb-3" id="tipsBox" hidden>
              <summary><strong>Tipy pred zaƒçat√≠m projektu</strong></summary>
              <div class="mt-2" id="tipsText"></div>
            </details>
            <button id="startProject" class="btn btn-primary">Zaƒça≈• projekt</button>
          </div>

          <!-- Krok (detail) -->
          <div id="stepView" hidden>
            <div id="stepContent"></div>
            <div class="d-flex justify-content-end gap-2 mt-3">
              <button class="btn btn-outline-secondary" id="prevStep">&larr; Predch√°dzaj√∫ci</button>
              <button class="btn btn-success" id="toggleDone">Oznaƒçi≈• ako hotov√©</button>
              <button class="btn btn-outline-secondary" id="nextStep">ƒéal≈°√≠ krok &rarr;</button>
            </div>
          </div>

          <!-- Introspekcia -->
          <div id="introspect" hidden>
            <p class="muted">Tvoje odpovede sa ukladaj√∫ iba lok√°lne (v prehliadaƒçi).</p>
            <div class="mb-2">
              <label class="form-label">1) Ak√© nov√© <strong>koncepty</strong> som sa nauƒçil/a?</label>
              <textarea id="rConcepts" rows="2" class="form-control"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">2) ƒåo bola moja najv√§ƒç≈°ia <strong>v√Ωzva</strong> v tomto projekte?</label>
              <textarea id="rChallenge" rows="2" class="form-control"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">Pozn√°mky</label>
              <textarea id="rNotes" rows="3" class="form-control"></textarea>
            </div>
            <div class="text-end">
              <button id="saveReflect" class="btn btn-primary">Ulo≈æi≈• reflexiu</button>
            </div>
          </div>
        </div>
      </div> <!-- /card -->
    </div>
  </div>
</section>

<!-- Modal: Gratul√°cia po dokonƒçen√≠ -->
<div class="modal fade" id="congratsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow-sm p-4">
      <h5 class="fw-semibold mb-2">üéâ Gratulujem, ukonƒçili ste tento projekt!</h5>
      <p class="mb-3 text-muted">
        Pre≈°li ste v≈°etky kroky, budovali ste rie≈°enie krok za krokom a zvl√°dli ste to. Skvel√° pr√°ca!
        Pokraƒçujte ƒèal≈°√≠m projektom alebo si tento ƒèalej vylep≈°ujte podƒæa seba.
      </p>
      <div class="text-end">
        <button class="btn btn-primary" data-bs-dismiss="modal">Pokraƒçova≈•</button>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  /* ---------- helpers ---------- */
  const $ = (s)=>document.querySelector(s);
  const esc = (s)=> (s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  function renderRich(txt){
    let s = esc(txt||'');
    s = s.replace(/`([^`]+)`/g, (_,m)=>`<code class="inline">${m}</code>`);
    s = s.replace(/\*\*([^*]+)\*\*/g, (_,m)=>`<span class="hl-kw">${m}</span>`);
    s = s.replace(/_([^_]+)_/g, '<em>$1</em>');
    return s.replace(/\n/g,'<br>');
  }
  function codeHtmlFromString(code, addedSet){
    const lines = (code||'').split('\n');
    return lines.map((ln,i)=>{
      const cls = addedSet.has(i) ? 'code-line added' : 'code-line';
      return `<span class="${cls}">${esc(ln)}</span>`;
    }).join('\n');
  }

  /* ---------- load payload ---------- */
  const url = new URL(location.href);
  const isPreview = url.searchParams.get('preview') === '1';
  let DATA = null;

  if(isPreview){
    try { DATA = JSON.parse(localStorage.getItem('project_preview_v1')||'null'); } catch(e){ DATA=null; }
  } else {
    try { DATA = JSON.parse(localStorage.getItem('project_published_v1')||'null'); } catch(e){ DATA=null; }
  }

  // Fallback minimal data if nothing stored
  if(!DATA){
    DATA = {
      meta:{
        title:'Blackjack', level:'Zaƒçiatoƒçn√≠k', category:'Hra', time:'~45‚Äì90 min',
        langs:{Python:true, JavaScript:true, HTML:true, CSS:true, SQL:false},
        preview:'https://blackjack.onrender.com', assignment:'Postupne vytvor√≠≈° konzolov√∫ hru Blackjack v Pythone.',
        tips:'Rob po mal√Ωch ƒçastiach a ƒçasto sp√∫≈°≈•aj program.'
      },
      steps:[]
    };
  }

  /* ---------- wire hero/meta ---------- */
  (function fillHero(){
    $('#heroTitle').textContent = DATA.meta.title || 'Bez n√°zvu';
    $('#heroLevel').textContent = '√örove≈à: ' + (DATA.meta.level || '‚Äì');
    $('#heroCategory').textContent = 'Kateg√≥ria: ' + (DATA.meta.category || '‚Äì');
    if (DATA.meta.time){ const t=$('#heroTime'); t.hidden=false; t.textContent='ƒåas: '+DATA.meta.time; }
    if (DATA.meta.preview){
      $('#heroPreview').hidden=false;
      const a=$('#heroPreviewLink'); a.href=DATA.meta.preview; a.textContent=DATA.meta.preview;
    }
    const badgeMap = { Python:'python.svg', JavaScript:'js.svg', HTML:'html.svg', CSS:'css.svg', SQL:'mysql.svg' };
    const box = $('#heroLangs'); box.innerHTML='';
    Object.entries(DATA.meta.langs||{}).forEach(([k,v])=>{
      if(!v) return;
      const span=document.createElement('span');
      span.className='badge';
      span.innerHTML = `<img src="{{ url_for('static', filename='icons') }}/${badgeMap[k]||'default.svg'}" alt="">${k}`;
      box.appendChild(span);
    });

    // assignment/tips
    $('#assignmentText').innerHTML = renderRich(DATA.meta.assignment||'‚Äî');
    if (DATA.meta.tips){ $('#tipsBox').hidden=false; $('#tipsText').innerHTML=renderRich(DATA.meta.tips); }

    // preview bar
    if(isPreview) document.getElementById('previewBar').classList.remove('d-none');
  })();

  /* ---------- steps render (dynamic) ---------- */
  const stepsUL = $('#steps');
  const doneCount = $('#doneCount');
  const progressBar = $('#progressBar');
  const panelTitle = $('#panelTitle');

  const assignmentView = document.getElementById('assignment');
  const stepView = document.getElementById('stepView');
  const introspectView = document.getElementById('introspect');

  const showAssignmentBtn = document.getElementById('showAssignment');
  const showIntrospectBtn = document.getElementById('showIntrospect');
  const startProjectBtn = document.getElementById('startProject');

  const stepContent = document.getElementById('stepContent');
  const prevStepBtn = document.getElementById('prevStep');
  const nextStepBtn = document.getElementById('nextStep');
  const toggleDoneBtn = document.getElementById('toggleDone');

  // state in this page
  const FILE_NAME_PLACE = '‚Äî';
  const store = {
    load(){
      try{
        const raw = localStorage.getItem('proj_runtime_state_v1_'+(DATA.meta.title||''));
        const base = { step:0, done:Array(DATA.steps.length).fill(false), notes:{} };
        if(!raw) return base;
        const parsed = JSON.parse(raw);
        const doneArr = Array(DATA.steps.length).fill(false).map((_,i)=> parsed.done ? !!parsed.done[i] : false);
        return { step: Math.min(parsed.step||0, DATA.steps.length-1), done: doneArr, notes: parsed.notes||{} };
      }catch(e){ return { step:0, done:Array(DATA.steps.length).fill(false), notes:{} }; }
    },
    save(s){ localStorage.setItem('proj_runtime_state_v1_'+(DATA.meta.title||''), JSON.stringify(s)); }
  };
  let state = store.load();

  function setPanel(which){
    assignmentView.hidden = which!=='A';
    stepView.hidden = which!=='S';
    introspectView.hidden = which!=='I';
    panelTitle.textContent = which==='A' ? 'Zadanie' : which==='S' ? `Krok ${state.step+1}: ${(DATA.steps[state.step]?.title)||''}` : 'Introspekcia';
  }
  showAssignmentBtn.onclick = ()=> setPanel('A');
  showIntrospectBtn.onclick = ()=> setPanel('I');
  startProjectBtn.onclick = ()=> { if(DATA.steps.length){ setPanel('S'); selectStep(0);} };

  function renderStepsSidebar(){
    stepsUL.innerHTML='';
    DATA.steps.forEach((s,i)=>{
      const li=document.createElement('li');
      const classes = ['border']; if(state.step===i) classes.push('active'); if(state.done[i]) classes.push('done');
      li.className = classes.join(' ');
      li.innerHTML = `<span class="idx">${i+1}</span><span class="fw-semibold">${esc(s.title||'Bez n√°zvu')}</span><span class="state">${state.done[i]?'‚úì hotovo':''}</span>`;
      li.onclick = ()=>{ state.step=i; store.save(state); selectStep(i); };
      stepsUL.appendChild(li);
    });
    const done = state.done.filter(Boolean).length;
    doneCount.textContent = `${done} / ${DATA.steps.length} hotovo`;
    progressBar.style.width = `${(DATA.steps.length? (done/DATA.steps.length)*100 : 0)}%`;
  }

  function renderStepBody(i){
    const S = DATA.steps[i] || {};
    const added = new Set((S.added||[]).filter(n=>typeof n==='number'));
    const hasCode = !!(S.code && S.code.length);

    stepContent.innerHTML = `
      <h3 class="h6 mb-1">${esc(S.title||'Bez n√°zvu')}</h3>
      ${S.explain? `<p>${renderRich(S.explain||'')}</p>`:''}
      ${(S.bullets&&S.bullets.length)?`<h4 class="h6 mt-3">Body</h4><ul>${S.bullets.map(b=>`<li>${renderRich(b)}</li>`).join('')}</ul>`:''}
      ${(S.checks&&S.checks.length)?`<h4 class="h6 mt-3">Checklist</h4><ul>${S.checks.map(b=>`<li>${renderRich(b)}</li>`).join('')}</ul>`:''}
      ${S.hint?`<details class="mb-2"><summary>Uk√°za≈• hinty</summary><div class="mt-2">${renderRich(S.hint||'')}</div></details>`:''}
      ${hasCode?`
        <details class="mb-0">
          <summary>Uk√°za≈• <u>cel√Ω k√≥d</u> (ako m√° vyzera≈• v tomto kroku)</summary>
          <div class="code-shell mt-2">
            <pre class="code-block"><button class="copy-btn" id="copyCode">Kop√≠rova≈• k√≥d</button><code>${codeHtmlFromString(S.code||'', added)}</code></pre>
            <div class="small text-muted mt-1">S√∫bor: <code>${esc(S.file||FILE_NAME_PLACE)}</code></div>
          </div>
        </details>`:''
      }
    `;

    if (hasCode){
      const copyBtn = document.getElementById('copyCode');
      copyBtn.onclick = ()=>{
        navigator.clipboard.writeText(S.code||'');
        const old = copyBtn.textContent; copyBtn.textContent='Skop√≠rovan√© ‚úì'; setTimeout(()=> copyBtn.textContent=old, 1100);
      };
    }
  }

  function updateToggleButton(){
    const isDone = state.done[state.step];
    if(isDone){
      toggleDoneBtn.className = 'btn btn-warning';
      toggleDoneBtn.textContent = 'Oznaƒçi≈• ako nedokonƒçen√©';
    }else{
      toggleDoneBtn.className = 'btn btn-success';
      toggleDoneBtn.textContent = 'Oznaƒçi≈• ako hotov√©';
    }
  }

  function selectStep(i){
    setPanel('S'); renderStepsSidebar(); updateToggleButton(); renderStepBody(i);

    toggleDoneBtn.onclick = ()=>{
      const wasDone = !!state.done[i];
      state.done[i] = !state.done[i];
      store.save(state);
      renderStepsSidebar(); updateToggleButton();

      if(!wasDone && state.done[i]){ // just completed
        if(i < DATA.steps.length - 1){
          state.step = i + 1; store.save(state); selectStep(state.step);
        }else{
          if (state.done.every(Boolean)){
            const el = document.getElementById('congratsModal');
            new bootstrap.Modal(el).show();
          }
        }
      }
    };
    prevStepBtn.onclick = ()=>{ if(i>0){ state.step=i-1; store.save(state); selectStep(state.step);} };
    nextStepBtn.onclick = ()=>{ if(i<DATA.steps.length-1){ state.step=i+1; store.save(state); selectStep(state.step);} };
  }

  // initial render
  renderStepsSidebar();
  setPanel('A');

  /* ---------- preview publish handlers ---------- */
  const previewBar = document.getElementById('previewBar');
  if(isPreview && previewBar){
    document.getElementById('btnDoPublish').onclick = ()=>{
      const payload = localStorage.getItem('project_preview_v1');
      if (payload) localStorage.setItem('project_published_v1', payload);
      // clear preview flag and reload as published
      const u = new URL(location.href); u.searchParams.delete('preview');
      window.location.replace(u.toString());
    };
  }
})();
</script>
{% endblock %}
