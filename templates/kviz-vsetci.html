{% extends "base.html" %}
{% block title %}Kvíz – Všetci autori{% endblock %}

{% block content %}
<style>
  :root{
    --panel:#fff; --soft:#f8fafc; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
    --ring:#3b82f6; --ring-weak:rgba(59,130,246,.08); --success:#16a34a; --danger:#dc2626;
    --success-weak:rgba(22,163,74,.12); --danger-weak:rgba(220,38,38,.12);
  }

  /* trošku väčší spacing nad nadpisom */
  .app-head{display:flex;align-items:center;justify-content:space-between;gap:.75rem;margin:18px 0 12px;}
  .app-head h4{margin:0;color:var(--text);font-weight:700;letter-spacing:.2px}

  .card-dashboard{border:1px solid var(--line);background:#fff;border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .toolbar .form-label{font-weight:600;color:#334155;margin-bottom:6px}
  .toolbar .form-select,.toolbar .form-control{height:40px;border-radius:10px;border:1px solid var(--line);padding:.5rem .7rem}
  .toolbar .form-select:focus,.toolbar .form-control:focus{border-color:#c7d2fe;box-shadow:0 0 0 .2rem var(--ring-weak)}
  .empty-msg{display:none;margin-top:8px;font-size:.9rem;color:#334155;background:#f8fafc;border:1px dashed #e2e8f0;border-radius:10px;padding:.5rem .7rem}

  .btn-min-primary{
    display:inline-flex;align-items:center;justify-content:center;
    padding:.56rem 1.1rem;border-radius:12px;font-weight:400;letter-spacing:.2px;
    color:#fff;background:#2563eb;border:1px solid #1e4fd1;
    box-shadow:0 1px 0 rgba(255,255,255,.15) inset,0 1px 2px rgba(0,0,0,.08);
    transition:background .15s,transform .06s
  }
  .btn-min-primary:hover{background:#1d4ed8}
  .btn-min-primary:active{transform:scale(.985)}
  .btn-min-secondary{display:inline-flex;align-items:center;justify-content:center;padding:.56rem 1rem;border-radius:12px;color:#0f172a;background:#fff;border:1px solid #d1d5db;transition:background .15s,border-color .15s,transform .06s}
  .btn-min-secondary:hover{background:#f9fafb;border-color:#cbd5e1}

  .quiz-premium .quiz-meta{display:flex;align-items:center;justify-content:space-between;color:var(--muted);font-size:.88rem;font-weight:600}
  .quiz-premium .chip{display:inline-flex;align-items:center;gap:.45rem;padding:.26rem .65rem;border-radius:999px;background:#eef2ff;color:#3730a3;font-weight:700;font-size:.75rem;border:1px solid #e0e7ff}
  .quiz-premium .progress{background:#eef2ff;height:9px;border-radius:999px;overflow:hidden}
  .quiz-premium .progress-bar{background:linear-gradient(90deg,#60a5fa,#3b82f6 60%,#2563eb);transition:width .35s ease}
  .quiz-premium .q-title{font-weight:800;font-size:1.1rem;color:#0b1220}

  .quiz-premium .choice{position:relative;display:flex;align-items:center;gap:.7rem;border:1px solid var(--line);border-radius:14px;padding:.7rem .8rem;background:#fff;cursor:pointer;user-select:none;transition:background .15s,border-color .15s,box-shadow .15s,transform .06s}
  .quiz-premium .choice + .choice{margin-top:10px}
  .quiz-premium .choice:hover{background:#f9fafb;border-color:#d7dceb}
  .quiz-premium .choice:active{transform:scale(.997)}
  .quiz-premium .choice input{position:absolute;opacity:0;width:0;height:0}
  .quiz-premium .bullet{width:20px;height:20px;border:2px solid #cbd5e1;border-radius:50%;background:#fff}
  .quiz-premium .choice .label{color:#0f172a;font-weight:600}
  .quiz-premium .choice.checked{border-color:#bfdbfe;box-shadow:0 0 0 .3rem var(--ring-weak);background:#fbfdff}
  .quiz-premium .choice.checked .bullet{border-color:#3b82f6;background:#3b82f6;box-shadow:inset 0 0 0 4px #fff}
  .quiz-premium .choice.is-correct{border-color:#16a34a;background:rgba(22,163,74,.12);box-shadow:0 0 0 .2rem rgba(22,163,74,.12)}
  .quiz-premium .choice.is-wrong{border-color:#dc2626;background:rgba(220,38,38,.12);box-shadow:0 0 0 .2rem rgba(220,38,38,.12)}

  .score{font-weight:800}
  .result-line .ok{color:#16a34a;font-weight:800}
  .result-line .bad{color:#dc2626;font-weight:800}

  footer { display: none; }

  .quiz-premium .q-title{
  font-weight:800;
  font-size:1.1rem;
  color:#0b1220;
  margin-top:14px;   /* väčší padding zhora */
  margin-bottom:8px; /* jemný odstup od možností */
}
</style>

<div class="app-head">
  <!-- odstránené tlačidlo „Späť na tvorbu“ -->
</div>

<!-- Toolbar -->
<div class="card-dashboard toolbar mb-3">
  <div class="row g-3 align-items-end">
    <div class="col-sm-6 col-md-3">
      <label class="form-label">Okruh</label>
      <select id="quizCategory" class="form-select">
        <option value="__all__">Všetko</option>
        <option>Python</option><option>JavaScript</option><option>HTML</option><option>CSS</option><option>SQL</option>
      </select>
    </div>
    <div class="col-sm-6 col-md-3">
      <label class="form-label">Podkategória</label>
      <select id="quizSubcategory" class="form-select">
        <option value="__all__">Všetko</option>
      </select>
    </div>
    <div class="col-sm-6 col-md-2">
      <label class="form-label">Počet otázok</label>
      <input id="quizCount" type="number" class="form-control" min="1" value="5">
    </div>
    <div class="col-md-4 d-grid d-md-flex gap-2">
      <button id="startQuizBtn" class="btn-min-primary w-100 w-md-auto">
        <i class="fas fa-play me-2"></i> <!-- medzera medzi ikonou a textom -->
        Spustiť kvíz
      </button>
      <button id="resetQuizBtn" class="btn-min-secondary" disabled>Zrušiť</button>
    </div>
  </div>
  <div id="emptyMsg" class="empty-msg"></div>
</div>

<!-- Quiz karta -->
<div id="quizArea" class="card-dashboard quiz-premium" style="display:none">
  <div class="quiz-progress">
    <div class="quiz-meta">
      <span id="progressText">Otázka 1/5</span>
      <span id="categoryChip" class="chip">Mix</span>
    </div>
    <div class="progress mt-2">
      <div id="progressBar" class="progress-bar" role="progressbar" style="width:0%"></div>
    </div>
  </div>

  <div id="qBox"></div>

  <div class="quiz-actions d-flex align-items-center justify-content-between gap-2 mt-3">
    <button id="prevBtn" class="btn btn-light" disabled><i class="fas fa-chevron-left me-1"></i> Predchádzajúca</button>
    <div class="d-flex gap-2">
      <button id="finishBtn" class="btn btn-outline-secondary" disabled>Vyhodnotiť</button>
      <button id="nextBtn" class="btn btn-primary">Ďalšia <i class="fas fa-chevron-right ms-1"></i></button>
    </div>
  </div>
</div>

<!-- Výsledok -->
<div id="resultBox" class="card-dashboard mt-3" style="display:none">
  <h6 class="mb-2">Výsledok</h6>
  <div id="scoreLine" class="score mb-2"></div>
  <div id="answerReview" class="small"></div>
  <div class="mt-3 d-flex gap-2">
    <button id="retryBtn" class="btn btn-primary btn-sm"><i class="fas fa-redo me-1"></i> Skúsiť znova</button>
    <a href="{{ url_for('kviz_vsetci') }}" class="btn btn-light btn-sm">Späť</a>
  </div>
</div>

<script>
(function() {
  // 1) Footer skry po načítaní stránky
  const baseFooter = document.querySelector('footer');

  const ICON_BASE = '/static/icons/';
  const iconMap = {'Python':'python.svg','JavaScript':'js.svg','HTML':'html.svg','CSS':'css.svg','SQL':'mysql.svg'};

  // Elements
  const quizCategory = document.getElementById('quizCategory');
  const quizSubcategory = document.getElementById('quizSubcategory');
  const quizCount = document.getElementById('quizCount');
  const startQuizBtn = document.getElementById('startQuizBtn');
  const resetQuizBtn = document.getElementById('resetQuizBtn');
  const quizArea = document.getElementById('quizArea');
  const qBox = document.getElementById('qBox');
  const progressText = document.getElementById('progressText');
  const progressBar = document.getElementById('progressBar');
  const categoryChip = document.getElementById('categoryChip');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const finishBtn = document.getElementById('finishBtn');
  const resultBox = document.getElementById('resultBox');
  const scoreLine = document.getElementById('scoreLine');
  const answerReview = document.getElementById('answerReview');
  const retryBtn = document.getElementById('retryBtn');
  const emptyMsg = document.getElementById('emptyMsg');

  let questions = [];
  let idx = 0;
  let answers = {};

  const escapeHtml = s => String(s).replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  const firstName = full => (String(full||'').trim().split(/\s+/)[0] || '');

  function showEmpty(msg){ emptyMsg.textContent = msg; emptyMsg.style.display = 'block'; }
  function hideEmpty(){ emptyMsg.textContent = ''; emptyMsg.style.display = 'none'; }

  // MIX všetkých autorov
  async function fetchRandomPool(count){
    const params = new URLSearchParams();
    params.set('scope','all');
    if (quizCategory.value !== '__all__') params.set('category', quizCategory.value);
    if (quizSubcategory.value !== '__all__') params.set('subcategory', quizSubcategory.value);
    params.set('limit', count);
    params.set('random', '1');

    const r = await fetch(`/api/questions?${params.toString()}`, {credentials:'same-origin'});
    const j = await r.json();
    if (!r.ok) throw new Error(j.error || 'Nepodarilo sa načítať otázky.');
    return j.items || [];
  }

  function renderCategoryChip(catValue){
    if (catValue === '__all__') {
      const allIcons = Object.values(iconMap)
        .map(name => `<img src="${ICON_BASE}${name}" alt="" style="height:18px;width:18px;margin-right:4px;">`)
        .join('');
      categoryChip.innerHTML = `<span class="d-inline-flex align-items-center">${allIcons}<strong>Mix</strong></span>`;
      return;
    }
    const icon = iconMap[catValue];
    if (icon) {
      categoryChip.innerHTML = `<span class="d-inline-flex align-items-center">
        <img src="${ICON_BASE}${icon}" alt="${catValue}" style="height:18px;width:18px;margin-right:6px;">
        <strong>${catValue}</strong>
      </span>`;
    } else {
      categoryChip.textContent = catValue;
    }
  }

  async function startQuiz() {
    const count = Math.max(1, parseInt(quizCount.value || '1', 10));
    try{
      const pool = await fetchRandomPool(count);
      if (!pool.length){
        const catLabel = quizCategory.value === '__all__' ? 'zvolenom výbere' : `okruhu „${quizCategory.value}”`;
        const scPart = (quizSubcategory.value !== '__all__') ? ` a podkategórii „${quizSubcategory.value}”` : '';
        showEmpty(`V ${catLabel}${scPart} zatiaľ nie sú žiadne otázky.`);
        quizArea.style.display = 'none';
        resultBox.style.display = 'none';
        return;
      }
      hideEmpty();

      questions = pool;
      idx = 0; answers = {};
      renderCategoryChip(quizCategory.value);

      quizArea.style.display = '';
      resultBox.style.display = 'none';
      resetQuizBtn.disabled = false;
      finishBtn.disabled = questions.length === 0;
      prevBtn.disabled = true;

      // 2) Footer zobraz AŽ teraz (po úspešnom štarte)
      if (baseFooter) baseFooter.style.display = 'block';

      renderQuestion();
      updateProgress();
    } catch(err){
      showEmpty(err.message || 'Chyba pri načítaní otázok.');
      quizArea.style.display = 'none';
      resultBox.style.display = 'none';
    }
  }

  function renderQuestion() {
    const q = questions[idx];
    const letters = ['A','B','C','D'];

    const choicesHtml = letters.map(letter => {
      const checked = answers[idx] === letter ? 'checked' : '';
      return `
        <label class="choice ${checked ? 'checked' : ''}">
          <input type="radio" name="q" value="${letter}" ${checked}>
          <span class="bullet"></span>
          <span class="label">(${letter}) ${escapeHtml(q[letter])}</span>
        </label>
      `;
    }).join('');

    qBox.innerHTML = `
      <div class="q-title">${escapeHtml(q.question)}</div>
      <div class="choices mt-2">${choicesHtml}</div>
    `;

    // klik na celú kartu
    qBox.querySelectorAll('.choice').forEach(choice => {
      choice.addEventListener('click', () => {
        const input = choice.querySelector('input[type="radio"]');
        if (!input.checked) { input.checked = true; input.dispatchEvent(new Event('change', { bubbles: true })); }
      });
    });
    qBox.querySelectorAll('input[name="q"]').forEach(r => {
      r.addEventListener('change', (e) => {
        answers[idx] = e.target.value;
        qBox.querySelectorAll('.choice').forEach(c => c.classList.remove('checked'));
        e.target.closest('.choice')?.classList.add('checked');
      });
    });

    prevBtn.disabled = (idx === 0);
    if (idx === questions.length - 1) {
      nextBtn.style.display = 'none';
      finishBtn.style.display = '';
      finishBtn.classList.remove('btn-outline-secondary');
      finishBtn.classList.add('btn-primary');
    } else {
      nextBtn.style.display = '';
      finishBtn.style.display = '';
      finishBtn.classList.remove('btn-primary');
      finishBtn.classList.add('btn-outline-secondary');
    }
  }

  function updateProgress() {
    progressText.textContent = `Otázka ${idx+1}/${questions.length}`;
    const pct = Math.round(((idx+1)/questions.length)*100);
    progressBar.style.width = pct + '%';
    progressBar.setAttribute('aria-valuenow', pct);
  }

  function flashFeedback(){
    const q = questions[idx];
    const chosen = answers[idx];
    if (!chosen) return false;
    const choiceEls = Array.from(qBox.querySelectorAll('.choice'));
    const map = {A:0,B:1,C:2,D:3};
    choiceEls.forEach(el => el.classList.remove('is-correct','is-wrong'));
    if (chosen === q.correct){ choiceEls[map[chosen]].classList.add('is-correct'); }
    else { choiceEls[map[chosen]].classList.add('is-wrong'); choiceEls[map[q.correct]].classList.add('is-correct'); }
    return true;
  }

  function next() {
    const had = flashFeedback();
    const go = () => { if (idx < questions.length - 1) { idx++; renderQuestion(); updateProgress(); } };
    if (had){ setTimeout(go, 650); } else { go(); }
  }

  function prev() { if (idx > 0) { idx--; renderQuestion(); updateProgress(); } }

  function evaluate() {
    let okCount = 0, review = '';
    questions.forEach((q, i) => {
      const chosen = answers[i] || '-';
      const ok = chosen === q.correct;
      if (ok) okCount++;
      review += `
        <div class="result-line mb-2">
          <strong>${i+1}.</strong>
          <span class="ms-2">Správna: <b>${q.correct}</b></span>
          <span class="ms-2">Tvoja: <span class="${ok?'ok':'bad'}">${chosen}</span></span>
          ${!ok ? `<div class="text-muted small mt-1">
            A: ${escapeHtml(q.A)} · B: ${escapeHtml(q.B)} · C: ${escapeHtml(q.C)} · D: ${escapeHtml(q.D)}
          </div>` : ''}
        </div>`;
    });
    scoreLine.textContent = `Skóre: ${okCount} / ${questions.length}`;
    answerReview.innerHTML = review;
    resultBox.style.display = '';
    window.scrollTo({ top: resultBox.offsetTop - 80, behavior: 'smooth' });
  }

  function resetAll() {
    questions = []; idx = 0; answers = {};
    quizArea.style.display = 'none';
    resultBox.style.display = 'none';
    resetQuizBtn.disabled = true;

    // 3) Pri zrušení kvízu opäť skry footer
    if (baseFooter) baseFooter.style.display = 'none';
  }

  // Wireup
  startQuizBtn.addEventListener('click', startQuiz);
  nextBtn.addEventListener('click', next);
  prevBtn.addEventListener('click', prev);
  finishBtn.addEventListener('click', ()=>{
    if (idx === questions.length - 1){
      const had = flashFeedback(); if (had){ setTimeout(evaluate, 650); } else { evaluate(); }
    } else { evaluate(); }
  });
  resetQuizBtn.addEventListener('click', resetAll);
  retryBtn.addEventListener('click', startQuiz);

  // Optional query params (?cat=Python&sub=...&n=10)
  const params = new URLSearchParams(location.search);
  if (params.get('cat')) quizCategory.value = params.get('cat');
  if (params.get('sub')) quizSubcategory.value = params.get('sub');
  if (params.get('n')) quizCount.value = params.get('n');
})();
</script>

{% endblock %}
