{# templates/projekty.html #}
{% extends 'base.html' %}
{% block title %}Projekty | Then This{% endblock %}

{% block content %}
{% set icon_files = {
  'Python': 'python.svg',
  'JavaScript': 'js.svg',
  'HTML': 'html.svg',
  'CSS': 'css.svg',
  'SQL': 'mysql.svg'
} %}

<style>
  .projects{
    --thumb-h: 160px;
    --icon-size: 80px;
    --icon-overlap: 7px;  /* koľko ikonka prečnieva do card-body */
    --icon-gap: 0px;     /* EXTRA medzera POD ikonou (uprav podľa chuti) */
  }
  .projects * { box-sizing: border-box; }

  .projects .card{
    border:1px solid #eef2f7;
    border-radius:20px;
    overflow:visible;
    background:#fff;
    box-shadow:0 6px 18px rgba(16,24,40,.04);
    transition: box-shadow .18s ease, transform .18s ease, border-color .18s ease;
  }
  .projects .card:hover{
    transform: translateY(-2px);
    border-color:#e7ecf4;
    box-shadow:0 10px 26px rgba(16,24,40,.07);
  }

  .projects .thumb{
    position:relative;
    height:var(--thumb-h);
    background:#eceff3 center/cover no-repeat;
    border-top-left-radius:20px;
    border-top-right-radius:20px;
    overflow:hidden;
    display:block;
    text-decoration:none;
  }
  .projects .thumb::after{
    content:"";
    position:absolute; inset:0;
    background:linear-gradient(180deg, rgba(0,0,0,0) 30%, rgba(0,0,0,.45) 100%);
  }

  /* menší steps „tag“ + skloňovanie pôjde JS-om */
  .projects .badge-steps{
    position:absolute; right:14px; top:14px; z-index:2;
    background:#2563eb; color:#fff;
    border-radius:999px; font-weight:400;     /* nie bold */
    padding:.16rem .49rem; font-size:.68rem;
    box-shadow:0 4px 12px rgba(37,99,235,.35);
    line-height:1.1;
  }

  .projects .proj-icon{
    position:absolute; left:16px;
    top: calc(var(--thumb-h) - (var(--icon-size) - var(--icon-overlap)));
    width:var(--icon-size); height:var(--icon-size); object-fit:cover;
    border-radius:18px; border:2px solid #fff; background:#fff;
    box-shadow:0 10px 22px rgba(16,24,40,.2); z-index:3; cursor:pointer;
  }

  /* posun obsahu KARTY nižšie = vznikne medzera pod ikonou */
  .projects .card-body{
    padding: calc(1.1rem + var(--icon-overlap) + var(--icon-gap)) 1.1rem 1.1rem 1.1rem;
  }

  .projects .title{
    font-size:1.26rem;
    font-weight:700;
    letter-spacing:-.01em;
    line-height:1.22;
    margin-bottom:.35rem;
  }

  .projects .meta-chip{
    background:#fff; color:#667085;
    border:1px solid #e9edf3; border-radius:999px;
    padding:.18rem .48rem; font-size:.74rem;   /* o chlp menšie */
    display:inline-flex; align-items:center; gap:.35rem;
  }

  .projects .langs .badge{
    background:#fff; border:1px solid #e9edf3; color:#374151;
    border-radius:999px; padding:.18rem .44rem; font-size:.74rem;
    display:inline-flex; align-items:center; gap:.35rem;
  }
  .projects .langs img{ width:16px; height:16px; }

  .projects .empty{
    border:1px dashed #e5e7eb; border-radius:20px;
    padding:2rem; text-align:center; color:#667085; background:#fff;
  }
</style>

<main class="projects container py-1">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="mb-0 mt-2" style="font-weight:700; letter-spacing:-.02em;">Nové projekty</h2>
    {# verejná stránka – žiadne tlačidlo „Vytvoriť projekt“ #}
  </div>

  {# Filtre #}
  <form class="row g-2 mb-3" id="projectFilters" onsubmit="return false;">
    <div class="col-sm-6 col-lg-3">
      <label class="form-label small text-muted">Kategória</label>
      <select id="filterCategory" class="form-select form-select-sm">
        <option value="">-- Všetky kategórie --</option>
        <option value="Hra">Hra</option>
        <option value="Appka">Appka</option>
        <option value="E-shop">E-shop</option>
        <option value="Mini nástroj">Mini nástroj</option>
        <option value="Iné">Iné</option>
      </select>
    </div>
    <div class="col-sm-6 col-lg-3">
      <label class="form-label small text-muted">Programovací jazyk</label>
      <select id="filterLang" class="form-select form-select-sm">
        <option value="">-- Všetky jazyky --</option>
        <option>Python</option><option>JavaScript</option><option>HTML</option><option>CSS</option><option>SQL</option>
      </select>
    </div>
    <div class="col-12 col-lg-6 d-flex align-items-end gap-2">
      <button type="button" id="btnClearFilters" class="btn btn-outline-secondary btn-sm">Vymazať filtre</button>
      <div id="resultCount" class="small text-muted ms-auto"></div>
    </div>
  </form>

  {% if not projects %}
    <div class="empty">Zatiaľ tu nie sú žiadne projekty.</div>
  {% else %}
    <div id="projectsGrid" class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-4">
      {% for p in projects %}
        {% set cover_path = p.cover_path or 'projects/placeholder-cover.jpg' %}
        {% set icon_path  = p.icon_path  or 'project-icons/default.png' %}
        {% set langs_list = p.langs_list %}
        {% set detail_url = url_for('projekt_public', project_id=p.id) %}

        <div class="col project-col"
             data-category="{{ p.category }}"
             data-langs="{{ (langs_list | join(',')) if langs_list else '' }}">
          <div class="card h-100 position-relative">
            <a href="{{ detail_url }}"
               class="thumb"
               aria-label="Otvoriť projekt: {{ p.title }}"
               style="background-image:url('{{ url_for('static', filename=cover_path) }}')">
              <span class="badge-steps" data-count="{{ p.steps_count or 0 }}"></span>
            </a>

            <img class="proj-icon"
                 src="{{ url_for('static', filename=icon_path) }}"
                 alt="ikonka"
                 data-href="{{ detail_url }}">

            <div class="card-body">
              <div class="title text-truncate">{{ p.title }}</div>

              <div class="d-flex flex-wrap gap-1 mb-2">
                {% if p.level %}<span class="meta-chip"><i class="fa-regular fa-signal-bars"></i><span>{{ p.level }}</span></span>{% endif %}
                {% if p.category %}<span class="meta-chip"><i class="fa-regular fa-grid-2"></i><span>{{ p.category }}</span></span>{% endif %}
                {% if p.time_estimate %}<span class="meta-chip"><i class="fa-regular fa-clock"></i><span>{{ p.time_estimate }}</span></span>{% endif %}
              </div>

              {% if langs_list %}
                <div class="langs d-flex flex-wrap gap-2 mb-2">
                  {% for L in langs_list %}
                    {% set Ls = L.strip() %}
                    <span class="badge">
                      <img src="{{ url_for('static', filename='icons/' ~ icon_files.get(Ls, 'default.svg')) }}" alt="{{ Ls }} ikonka">{{ Ls }}
                    </span>
                  {% endfor %}
                </div>
              {% endif %}

              <div class="d-flex justify-content-end align-items-center">
                <a href="{{ detail_url }}#start" class="btn btn-primary btn-sm">Začať projekt</a>
              </div>

            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}
</main>

<script>
(function(){
  const $  = (s)=>document.querySelector(s);

  // správne skloňovanie „krokov“
  function skKroky(n){
    n = Number(n)||0;
    if (n === 1) return '1 krok';
    if (n >= 2 && n <= 4) return n + ' kroky';
    return n + ' krokov';
  }

  // vyplň text na „steps badge“
  document.querySelectorAll('.badge-steps').forEach(b=>{
    const n = b.getAttribute('data-count');
    b.textContent = skKroky(n);
  });

  // klik na ikonku na karte -> detail
  document.querySelectorAll('.proj-icon').forEach(img=>{
    img.addEventListener('click', (e)=>{
      e.preventDefault(); e.stopPropagation();
      const href = img.getAttribute('data-href'); if (href) location.href = href;
    });
  });

  // Filtre (klient-side)
  const filterCategory = $('#filterCategory');
  const filterLang     = $('#filterLang');
  const resultCount    = $('#resultCount');

  function applyFilters(){
    const cat = (filterCategory?.value || '').trim();
    const lang= (filterLang?.value || '').trim();
    const cols = Array.from(document.querySelectorAll('#projectsGrid .project-col'));

    let visible = 0;
    cols.forEach(col=>{
      const c = col.getAttribute('data-category') || '';
      const langs = (col.getAttribute('data-langs') || '').split(',').map(s=>s.trim()).filter(Boolean);
      const okCat  = !cat  || c === cat;
      const okLang = !lang || langs.includes(lang);
      const show = okCat && okLang;
      col.style.display = show ? '' : 'none';
      if (show) visible++;
    });

    resultCount.textContent = `${visible} / ${cols.length} výsledkov`;
  }

  filterCategory?.addEventListener('change', applyFilters);
  filterLang?.addEventListener('change', applyFilters);
  document.getElementById('btnClearFilters')?.addEventListener('click', ()=>{
    if (filterCategory) filterCategory.value = '';
    if (filterLang) filterLang.value = '';
    applyFilters();
  });

  applyFilters();
})();
</script>
{% endblock %}
