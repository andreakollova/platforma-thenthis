{# templates/projekt-vytvorit.html #}
{% extends "base-dashboard.html" %}
{% block title %}Vytvoriť projekt{% endblock %}

{% block content %}
<style>
  .builder * { box-sizing: border-box; }
  .builder .card { border-radius: 1rem; overflow: hidden; }
  .builder .card-header, .builder .card-body { padding: .8rem 1rem; }
  .builder .pill { border:1px solid #e5e7eb; background:#fff; border-radius:999px; padding:.25rem .55rem; font-size:.8rem; color:#6b7280; }
  .builder .muted { color:#6b7280; }
  .builder .small-muted { color:#9ca3af; font-size:.8rem; }

  /* focus bez modrého orámovania */
  .builder .form-control:focus,
  .builder .form-select:focus {
    box-shadow: none !important;
    outline: none !important;
    border-color: #cbd5e1 !important;
  }

  /* sidebar kroky */
  .builder .steps { list-style: none; padding-left: 0; margin: 0; }
  .builder .steps li {
    display:flex; align-items:center; gap:.5rem; padding:.55rem .6rem;
    border-radius:.75rem; cursor:pointer; border:1px solid transparent;
    overflow: hidden;                    /* nech sa obsah naviac odreže */
  }
  .builder .steps li:hover { background:#f8fafc; }
  .builder .steps li.active { background:#eff6ff; border:1px solid #bfdbfe; }
  .builder .steps .idx {
    width:28px; height:28px; display:grid; place-items:center;
    border-radius:.6rem; border:1px solid #e5e7eb; background:#fff;
    font-weight:700; font-size:.8rem; color:#111827; flex:0 0 28px;
  }

  /* DOPLNENÉ: kontajner pre text má byť flex:1 a min-width:0,
     potom funguje elipsa (…); použijeme ju na názov aj na "Súbor:" */
  .builder .steps li .title { flex: 1; min-width: 0; }     /* <<< kľúčové */
  .builder .steps li .title .fw-semibold,
  .builder .steps li .title small {
    display:block;
    overflow:hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  /* náhľad ikonky projektu v menu – vždy štvorec */
  .builder .steps .idx-img{
    width:28px; height:28px; border-radius:.6rem;
    border:1px solid #e5e7eb; object-fit:cover; background:#fff; flex:0 0 28px;
  }

  .builder .code-shell { position:relative; }
  .builder pre.code-block{
    margin:0; background:#0f172a; color:#dbeafe; border-radius:.6rem; font-size:.82rem;
    padding:1.45rem .55rem .40rem .65rem; overflow:auto;
  }
  .builder pre.code-block code{
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    white-space: pre; display:block; line-height:1.04;
  }
  .builder .code-line{ display:block; width:100%; padding-left:.52rem; border-left:3px solid transparent; cursor:pointer; min-height:1.04em; }
  .builder .code-line.added{ border-left-color:#22c55e; }
  .builder .copy-btn{ position:absolute; top:.35rem; right:.35rem; z-index:2; border:1px solid #1f2937; background:#111827; color:#dbeafe; border-radius:.4rem; padding:.16rem .42rem; font-size:.72rem; }
  .builder .file-badge{ background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:.15rem .5rem; font-size:.75rem; }
  .builder .progress-thin{ height:8px; background:#f3f4f6; border-radius:999px; overflow:hidden; border:1px solid #e5e7eb; }
  .builder .progress-thin>i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#3b82f6,#22c55e); }
  .builder .lang-badges .badge{ background:#fff; border:1px solid #e5e7eb; color:#374151; border-radius:999px; padding:.2rem .5rem; display:inline-flex; align-items:center; gap:.35rem; }
  .builder .lang-badges .badge img{ width:16px; height:16px; }

  /* ružové zvýraznenie – zobrazí sa na detaile */
  .hl-kw{
    color:#ec4899;
    font-weight:800;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
  }
  .builder code.inline{ background:#111827; color:#dbeafe; padding:.05rem .3rem; border-radius:.35rem; }

  /* uploader náhľady – presne štvorec + pevná šírka (nech sa nezúži vo flexe) */
  .uploader .thumb {
    width:84px; height:84px; aspect-ratio:1/1;
    border-radius:14px; border:1px solid #e5e7eb;
    background:#f8fafc center/cover no-repeat;
    flex:0 0 84px;
  }
  .uploader .cover {
    width:100%; height:140px; border-radius:14px; border:1px solid #e5e7eb; background:#f8fafc center/cover no-repeat;
  }
  .uploader small { color:#6b7280; }

  /* malé, svetlosivé highlighter ikonky – bez rámčeka, jemne vyššie */
  .hl-btn{
    padding:.1rem .25rem;
    border:none !important;
    background:transparent !important;
    color:#c7cfd8 !important;   /* svetlá sivá */
    line-height:1;
    transform: translateY(-2px);
  }
  .hl-btn:hover{ color:#6b7280 !important; background:transparent !important; }
  .hl-btn i{ font-size:.82rem; }

  /* čierne „+“ pri krokoch/checkliste */
  #btnAddBullet i, #btnAddCheck i { color:#111827; }
</style>

<main class="builder container py-1">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
      <h1 class="h4 mb-0">Vytvoriť projekt</h1>
      <span class="pill">nový</span>
    </div>
      <div class="d-flex gap-2">
        <button class="btn btn-primary btn-sm" id="btnPublish">
          <i class="fa-solid fa-arrow-right"></i> Publikovať
        </button>
      </div>
  </div>

  <div class="row g-3">
    <!-- SIDEBAR -->
    <div class="col-12 col-lg-4">
      <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="fw-semibold">Menu</div>
          <div class="small text-muted"><span id="stepCount">0</span> krokov</div>
        </div>
        <div class="card-body">
          <ul id="stepsList" class="steps" role="tablist" aria-label="Kroky"></ul>
          <div class="d-grid mt-2">
            <button class="btn btn-outline-primary btn-sm" id="btnAddStep">
              <i class="fa-solid fa-plus me-1"></i>Pridať krok
            </button>
          </div>
          <hr>
          <div class="progress-thin" aria-label="Priebeh">
            <i id="progressBar"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: META / STEP -->
    <div class="col-12 col-lg-8">
      <!-- META -->
      <div id="metaView" class="card shadow-sm mb-3">
        <div class="card-header"><div class="fw-semibold">Projekt — základné informácie</div></div>
        <div class="card-body">
          <form id="metaForm" onsubmit="return false;">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label fw-semibold small text-uppercase text-muted">Názov projektu</label>
                <input type="text" class="form-control" id="metaTitle">
              </div>
              <div class="col-6">
                <label class="form-label fw-semibold small text-uppercase text-muted">Úroveň</label>
                <select id="metaLevel" class="form-select">
                  <option>Začiatočník</option><option>Stredne pokročilý</option><option>Pokročilý</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label fw-semibold small text-uppercase text-muted">Kategória</label>
                <select id="metaCategory" class="form-select">
                  <option>Hra</option><option>Appka</option><option>E-shop</option><option>Mini nástroj</option><option>Iné</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label fw-semibold small text-uppercase text-muted">Čas (odhad)</label>
                <input type="text" class="form-control" id="metaTime" placeholder="napr. ~45–90 min">
              </div>
              <div class="col-6">
                <label class="form-label fw-semibold small text-uppercase text-muted">Náhľad URL</label>
                <input type="url" class="form-control" id="metaPreview" placeholder="https://...">
              </div>

              <div class="col-12">
                <label class="form-label fw-semibold small text-uppercase text-muted d-block">Použité jazyky (globálne)</label>
                <div class="lang-badges d-flex flex-wrap gap-2">
                  <label class="badge"><img src="{{ url_for('static', filename='icons/python.svg') }}" alt="">Python
                    <input class="form-check-input ms-2" type="checkbox" value="Python" id="langPython">
                  </label>
                  <label class="badge"><img src="{{ url_for('static', filename='icons/js.svg') }}" alt="">JavaScript
                    <input class="form-check-input ms-2" type="checkbox" value="JavaScript" id="langJS">
                  </label>
                  <label class="badge"><img src="{{ url_for('static', filename='icons/html.svg') }}" alt="">HTML
                    <input class="form-check-input ms-2" type="checkbox" value="HTML" id="langHTML">
                  </label>
                  <label class="badge"><img src="{{ url_for('static', filename='icons/css.svg') }}" alt="">CSS
                    <input class="form-check-input ms-2" type="checkbox" value="CSS" id="langCSS">
                  </label>
                  <label class="badge"><img src="{{ url_for('static', filename='icons/mysql.svg') }}" alt="">SQL
                    <input class="form-check-input ms-2" type="checkbox" value="SQL" id="langSQL">
                  </label>
                </div>
              </div>

              <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                  <label class="form-label fw-semibold small text-uppercase text-muted mb-0">Zadanie</label>
                  <button type="button" class="hl-btn" id="hlAssignment" title="Zvýrazniť">
                    <i class="fa-solid fa-highlighter"></i>
                  </button>
                </div>
                <textarea id="metaAssignment" class="form-control" rows="3" placeholder="Stručný popis čo ideme stavať..."></textarea>
                <div class="small-muted mt-1">Vyber text a klikni na ikonu. Na detaile sa zobrazí <span class="hl-kw">ružovo (monospace)</span>.</div>
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold small text-uppercase text-muted">Tipy pred začiatkom</label>
                <textarea id="metaTips" class="form-control" rows="3" placeholder="Krátke tipy, odporúčania..."></textarea>
              </div>

              <!-- IKONKA + COVER UPLOAD -->
              <div class="col-12">
                <div class="uploader row g-3 align-items-center">
                  <div class="col-sm-6">
                    <label class="form-label d-flex align-items-center justify-content-between">
                      <span>Ikonka projektu</span>
                      <small id="metaIconPathLabel" class="text-muted"></small>
                    </label>
                    <div class="d-flex align-items-center gap-3">
                      <div id="metaIconPreview" class="thumb"></div>
                      <div>
                        <input type="file" id="metaIcon" accept="image/*" class="form-control form-control-sm">
                        <small>Štvorcový obrázok, napr. 256×256.</small>
                      </div>
                    </div>
                  </div>
                  <div class="col-sm-6">
                    <label class="form-label d-flex align-items-center justify-content-between">
                      <span>Cover obrázok</span>
                      <small id="metaCoverPathLabel" class="text-muted"></small>
                    </label>
                    <div class="cover" id="metaCoverPreview"></div>
                    <div class="mt-2">
                      <input type="file" id="metaCover" accept="image/*" class="form-control form-control-sm">
                      <small>Vodorovný obrázok ~1200×600.</small>
                    </div>
                  </div>
                </div>
              </div>
              <!-- /IKONKA + COVER -->
            </div>
          </form>
        </div>
      </div>

      <!-- STEP -->
      <div id="stepView" class="card shadow-sm" hidden>
        <div class="card-header d-flex align-items-center justify-content-between">
          <div>
            <div class="fw-semibold" id="stepHeaderTitle">Krok — nový</div>
            <div class="small text-muted" id="stepHeaderFile">Súbor: (zatím nevyplnené)</div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary btn-sm" id="btnStepUp" title="Posunúť vyššie">↑</button>
            <button class="btn btn-outline-secondary btn-sm" id="btnStepDown" title="Posunúť nižšie">↓</button>
            <button class="btn btn-outline-danger btn-sm" id="btnStepDelete" title="Vymazať krok"><i class="fa-regular fa-trash-can"></i></button>
          </div>
        </div>
        <div class="card-body">
          <form id="stepForm" onsubmit="return false;">
            <div class="mb-2">
              <label class="form-label fw-semibold small text-uppercase text-muted">Názov kroku</label>
              <input type="text" class="form-control" id="stepTitle">
            </div>

            <div class="mb-2">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label fw-semibold small text-uppercase text-muted mb-0">Popis (čo ideš spraviť)</label>
                <button type="button" class="hl-btn" id="hlExplain" title="Zvýrazniť">
                  <i class="fa-solid fa-highlighter"></i>
                </button>
              </div>
              <textarea id="stepExplain" class="form-control" rows="3"></textarea>
            </div>

            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label d-flex align-items-center justify-content-between">
                  <span class="fw-semibold">Kroky</span>
                  <button class="btn btn-sm btn-outline-secondary" id="btnAddBullet" type="button" title="Pridať">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </label>
                <div id="bulletsBox" class="d-grid gap-2"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label d-flex align-items-center justify-content-between">
                  <span class="fw-semibold">Checklist</span>
                  <button class="btn btn-sm btn-outline-secondary" id="btnAddCheck" type="button" title="Pridať">
                    <i class="fa-solid fa-plus"></i>
                  </button>
                </label>
                <div id="checksBox" class="d-grid gap-2"></div>
              </div>
            </div>

            <div class="mb-2">
              <div class="d-flex justify-content-between align-items-center">
                <label class="form-label fw-semibold small text-uppercase text-muted mb-0">Hinty</label>
                <button type="button" class="hl-btn" id="hlHint" title="Zvýrazniť">
                  <i class="fa-solid fa-highlighter"></i>
                </button>
              </div>
              <textarea id="stepHint" class="form-control" rows="2"></textarea>
            </div>

            <hr>

            <div class="row g-2">
              <div class="col-md-12">
                <label class="form-label fw-semibold small text-uppercase text-muted">Súbor (názov s príponou)</label>
                <input type="text" class="form-control" id="stepFile" placeholder="napr. app.py, main.js, index.html">
              </div>
            </div>

            <!-- CODE EDITOR + INLINE MARKER -->
            <div class="mt-2">
              <label class="form-label fw-semibold small text-uppercase text-muted">Kód</label>
              <textarea id="stepCode" class="form-control font-monospace" rows="10"
                placeholder="# sem vlož KÓD kroku – HTML sa zobrazí iba ako text (nie ako stránka)"></textarea>
              <input type="hidden" id="stepAdded" value="">
              <div class="small-muted mt-1">Kliknutím na riadok v náhľade nižšie ho označíš ako <span style="border-left:3px solid #22c55e;padding-left:4px;">nový</span>.</div>

              <div class="code-shell mt-2">
                <pre class="code-block"><button class="copy-btn" id="copyInline" type="button">Kopírovať kód</button><code id="codePreview"></code></pre>
                <div class="d-flex justify-content-between mt-1">
                  <div class="small text-muted">Súbor: <code id="previewFileLabel">—</code></div>
                  <button class="btn btn-sm btn-outline-secondary" id="btnClearMarks" type="button">Vymazať označenia</button>
                </div>
              </div>
            </div>
          </form>

          <div class="text-end mt-3">
            <button class="btn btn-primary" id="btnApplyStep">Uložiť krok</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
(function(){
  const $ = (s)=>document.querySelector(s);
  const esc = (s)=> (s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  const STATIC_BASE = "{{ url_for('static', filename='') }}";

  // === zvýraznenie: vkladáme **…** (na detaile sa z toho stane <span class="hl-kw">…</span>)
  function toggleHighlight(el){
    const prefix = '**', suffix = '**';
    const start = el.selectionStart ?? 0;
    const end   = el.selectionEnd   ?? 0;
    const v = el.value || '';

    if (start === end) {
      el.value = v.slice(0,start) + prefix + suffix + v.slice(end);
      const pos = start + prefix.length;
      el.focus(); el.selectionStart = el.selectionEnd = pos;
      el.dispatchEvent(new Event('input', {bubbles:true}));
      return;
    }

    const sel = v.slice(start, end);
    const before = v.slice(0, start);
    const after = v.slice(end);

    if (sel.startsWith(prefix) && sel.endsWith(suffix)) {
      const inner = sel.slice(prefix.length, sel.length - suffix.length);
      el.value = before + inner + after;
      el.focus(); el.selectionStart = start; el.selectionEnd = start + inner.length;
    } else if (v.slice(Math.max(0,start-prefix.length), start) === prefix &&
               v.slice(end, end+suffix.length) === suffix) {
      const realStart = start - prefix.length, realEnd = end + suffix.length;
      el.value = v.slice(0, realStart) + sel + v.slice(realEnd);
      el.focus(); el.selectionStart = realStart; el.selectionEnd = realStart + sel.length;
    } else {
      el.value = before + prefix + sel + suffix + after;
      const s2 = start + prefix.length, e2 = s2 + sel.length;
      el.focus(); el.selectionStart = s2; el.selectionEnd = e2;
    }
    el.dispatchEvent(new Event('input', {bubbles:true}));
  }

  const STORE_KEY = 'project_builder_db_v1';
  let meta = {
    title:'', level:'Začiatočník', category:'Hra', time:'', preview:'',
    langs:{ Python:false, JavaScript:false, HTML:false, CSS:false, SQL:false },
    assignment:'', tips:'',
    icon_path:null, cover_path:null
  };
  let steps = [];    // [{title,explain,bullets[],checks[],hint,file,code,added[]}]
  let current = -1;  // -1=meta

  // čistý štart (iba ak nie je ?resume=1)
  const url = new URL(location.href);
  const resume = url.searchParams.get('resume') === '1';
  if (!resume) localStorage.removeItem(STORE_KEY);

  // refs
  const stepsList = $('#stepsList'); const stepCount=$('#stepCount'); const progressBar=$('#progressBar');
  const metaView=$('#metaView'); const stepView=$('#stepView');
  const metaTitle=$('#metaTitle'); const metaLevel=$('#metaLevel'); const metaCategory=$('#metaCategory');
  const metaTime=$('#metaTime'); const metaPreview=$('#metaPreview'); const metaAssignment=$('#metaAssignment'); const metaTips=$('#metaTips');
  const langPython=$('#langPython'); const langJS=$('#langJS'); const langHTML=$('#langHTML'); const langCSS=$('#langCSS'); const langSQL=$('#langSQL');

  const metaIcon=$('#metaIcon'); const metaCover=$('#metaCover');
  const metaIconPreview=$('#metaIconPreview'); const metaCoverPreview=$('#metaCoverPreview');
  const metaIconPathLabel=$('#metaIconPathLabel'); const metaCoverPathLabel=$('#metaCoverPathLabel');

  const stepHeaderTitle=$('#stepHeaderTitle'); const stepHeaderFile=$('#stepHeaderFile');
  const stepTitle=$('#stepTitle'); const stepExplain=$('#stepExplain'); const bulletsBox=$('#bulletsBox'); const checksBox=$('#checksBox');
  const stepHint=$('#stepHint'); const stepFile=$('#stepFile'); const stepCode=$('#stepCode'); const stepAdded=$('#stepAdded');
  const codePreview=$('#codePreview'); const previewFileLabel=$('#previewFileLabel');
  const btnAddStep=$('#btnAddStep'); const btnApplyStep=$('#btnApplyStep');
  const btnClearMarks=$('#btnClearMarks'); const btnCopyInline=$('#copyInline');
  const btnPublish=$('#btnPublish');
  const btnAddBullet=$('#btnAddBullet'); const btnAddCheck=$('#btnAddCheck');

  // storage
  const saveLocal = ()=> localStorage.setItem(STORE_KEY, JSON.stringify({meta,steps,current}));
  function loadLocal(){
    try{
      const raw=localStorage.getItem(STORE_KEY);
      if(!raw) return;
      const p=JSON.parse(raw);
      meta=p.meta||meta; steps=p.steps||[]; current=(typeof p.current==='number')?p.current:-1;
    }catch(e){}
  }

  // meta render/update
  function renderMeta(){
    metaTitle.value=meta.title; metaLevel.value=meta.level; metaCategory.value=meta.category;
    metaTime.value=meta.time; metaPreview.value=meta.preview; metaAssignment.value=meta.assignment; metaTips.value=meta.tips;
    langPython.checked=!!meta.langs.Python; langJS.checked=!!meta.langs.JavaScript; langHTML.checked=!!meta.langs.HTML; langCSS.checked=!!meta.langs.CSS; langSQL.checked=!!meta.langs.SQL;

    // previews
    metaIconPreview.style.backgroundImage = meta.icon_path ? `url('${STATIC_BASE}${meta.icon_path}')` : 'none';
    metaCoverPreview.style.backgroundImage = meta.cover_path ? `url('${STATIC_BASE}${meta.cover_path}')` : 'none';
    metaIconPathLabel.textContent = meta.icon_path ? ('project-icon') : '';
    metaCoverPathLabel.textContent = meta.cover_path ? ('cover') : '';
  }
  function updateMeta(){
    meta.title=metaTitle.value.trim(); meta.level=metaLevel.value; meta.category=metaCategory.value;
    meta.time=metaTime.value.trim(); meta.preview=metaPreview.value.trim(); meta.assignment=metaAssignment.value; meta.tips=metaTips.value;
    meta.langs={ Python:langPython.checked, JavaScript:langJS.checked, HTML:langHTML.checked, CSS:langCSS.checked, SQL:langSQL.checked };
    saveLocal();
  }
  ;['input','change'].forEach(evt=>{
    [metaTitle,metaLevel,metaCategory,metaTime,metaPreview,metaAssignment,metaTips,langPython,langJS,langHTML,langCSS,langSQL].forEach(el=>{
      el.addEventListener(evt, updateMeta);
    });
  });

  // upload helper
  async function uploadImage(file, kind){
    const fd = new FormData();
    fd.append('file', file);
    fd.append('kind', kind);
    const res = await fetch("{{ url_for('api_upload_project_image') }}", {
      method:'POST', body: fd, credentials:'same-origin'
    });
    const data = await res.json().catch(()=>({}));
    if(!res.ok || data.ok === false || !data.path){
      throw new Error(data.error || 'Upload zlyhal');
    }
    return data.path;
  }

  // sidebar
  function renderStepsList(){
    stepsList.innerHTML='';

    const metaLi=document.createElement('li');
    metaLi.className='border meta'+(current===-1?' active':'');
    const iconHTML = meta.icon_path
      ? `<img class="idx-img" src="${STATIC_BASE}${meta.icon_path}" alt="ikonka">`
      : `<span class="idx" aria-hidden="true"></span>`;
    metaLi.innerHTML=`
      ${iconHTML}
      <div class="title">
        <div class="fw-semibold">Projekt — základné informácie</div>
        <small>Názov, úroveň, jazyky…</small>
      </div>`;
    metaLi.onclick=()=> selectMeta();
    stepsList.appendChild(metaLi);

    steps.forEach((s,i)=>{
      const li=document.createElement('li');
      li.className='border'+(current===i?' active':'');
      li.innerHTML=`
        <span class="idx">${i+1}</span>
        <div class="title">
          <div class="fw-semibold text-truncate">${esc(s.title||'Bez názvu')}</div>
          <small class="text-truncate">Súbor: ${esc(s.file||'—')}</small>
        </div>`;
      li.onclick=()=> selectStep(i);
      stepsList.appendChild(li);
    });

    stepCount.textContent=String(steps.length);
    const pct = steps.length ? (steps.filter(s=> (s.title && s.code)).length/steps.length)*100 : 0;
    progressBar.style.width=pct+'%';
  }
  function selectMeta(){ current=-1; saveLocal(); metaView.hidden=false; stepView.hidden=true; renderStepsList(); }
  function selectStep(i){ current=i; saveLocal(); metaView.hidden=true; stepView.hidden=false; renderStepEditor(); renderStepsList(); }

  // bullets/checks helpers
  function addBulletRow(text=''){
    const el=document.createElement('div'); el.className='input-group';
    el.innerHTML=`
      <span class="input-group-text">•</span>
      <input type="text" class="form-control step-md-input" value="${text.replace(/"/g,'&quot;')}">
      <button class="hl-btn" type="button" data-role="hl" title="Zvýrazniť"><i class="fa-solid fa-highlighter"></i></button>
      <button class="btn btn-outline-secondary" type="button" data-role="del">×</button>`;
    const input = el.querySelector('input');
    el.querySelector('[data-role="hl"]').onclick = ()=> toggleHighlight(input);
    el.querySelector('[data-role="del"]').onclick = ()=> el.remove();
    bulletsBox.appendChild(el);
  }
  function addCheckRow(text=''){
    const el=document.createElement('div'); el.className='input-group';
    el.innerHTML=`
      <span class="input-group-text"><i class="fa-regular fa-square"></i></span>
      <input type="text" class="form-control step-md-input" value="${text.replace(/"/g,'&quot;')}">
      <button class="hl-btn" type="button" data-role="hl" title="Zvýrazniť"><i class="fa-solid fa-highlighter"></i></button>
      <button class="btn btn-outline-secondary" type="button" data-role="del">×</button>`;
    const input = el.querySelector('input');
    el.querySelector('[data-role="hl"]').onclick = ()=> toggleHighlight(input);
    el.querySelector('[data-role="del"]').onclick = ()=> el.remove();
    checksBox.appendChild(el);
  }

  // code preview + toggles
  function renderCodePreview(){
    const lines = (stepCode.value||'').split('\n');
    const kept = (stepAdded.value||'')
      .split(',')
      .map(x=>x.trim())
      .filter(Boolean)
      .map(x=>+x)
      .filter(n=>!isNaN(n) && n>=0 && n<lines.length);

    stepAdded.value = kept.join(',');
    const set = new Set(kept);
    const html = lines.map((ln,i)=>`<span class="code-line ${set.has(i)?'added':''}" data-line="${i}">${esc(ln)}</span>`).join('\n');
    codePreview.innerHTML = html;
    previewFileLabel.textContent = stepFile.value || '—';

    if (codePreview._handler) codePreview.removeEventListener('click', codePreview._handler);
    codePreview._handler = (e)=>{
      const s = e.target.closest('.code-line'); if(!s) return;
      s.classList.toggle('added');
      const idxs = Array.from(codePreview.querySelectorAll('.code-line'))
        .map((n,idx)=> n.classList.contains('added')?idx:null)
        .filter(v=>v!==null);
      stepAdded.value = idxs.join(',');
      if (current>=0 && steps[current]) { steps[current].added = idxs; saveLocal(); }
    };
    codePreview.addEventListener('click', codePreview._handler);
  }

  function renderStepEditor(){
    const s = steps[current] || {};
    stepHeaderTitle.textContent = s.title ? `Krok — ${s.title}` : 'Krok — nový';
    stepHeaderFile.innerHTML = `Súbor: <code>${esc(s.file||'—')}</code>`;
    stepTitle.value = s.title || '';
    stepExplain.value = s.explain || '';
    stepHint.value = s.hint || '';
    stepFile.value = s.file || '';
    stepCode.value = s.code || '';
    bulletsBox.innerHTML=''; (s.bullets||[]).forEach(t=>addBulletRow(t));
    checksBox.innerHTML=''; (s.checks||[]).forEach(t=>addCheckRow(t));

    // nič defaultne neoznačuj (alebo z DB)
    const linesLen = (stepCode.value||'').split('\n').length;
    const safeAdded = (s.added||[]).filter(n=> typeof n==='number' && n>=0 && n<linesLen);
    stepAdded.value = safeAdded.join(',');
    renderCodePreview();
  }

  function applyStepForm(){
    const bullets = Array.from(bulletsBox.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
    const checks = Array.from(checksBox.querySelectorAll('input')).map(i=>i.value.trim()).filter(Boolean);
    const added = (stepAdded.value||'').split(',').map(x=>+x.trim()).filter(n=>!isNaN(n));

    const obj = {
      title: stepTitle.value.trim(),
      explain: stepExplain.value,
      bullets, checks,
      hint: stepHint.value,
      file: stepFile.value.trim(),
      code: stepCode.value,
      added
    };
    if(!steps.length || current===-1){ steps.push(obj); current = steps.length-1; }
    else { steps[current] = obj; }

    saveLocal(); renderStepsList(); renderStepEditor();
    toast('Krok uložený ✔');
  }

  function newStep(){
    steps.push({title:'',explain:'',bullets:[],checks:[],hint:'',file:'',code:'',added:[]});
    current=steps.length-1; saveLocal(); renderStepsList(); renderStepEditor(); selectStep(current);
  }

  function toast(msg){
    const t=document.createElement('div'); t.className='position-fixed bottom-0 end-0 p-3';
    t.innerHTML=`<div class="alert alert-success shadow-sm mb-0">${msg}</div>`;
    document.body.appendChild(t); setTimeout(()=>t.remove(),1300);
  }

  // uploads
  metaIcon.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    try{
      const path = await uploadImage(file, 'icon');
      meta.icon_path = path;
      metaIconPreview.style.backgroundImage = `url('${STATIC_BASE}${path}')`;
      metaIconPathLabel.textContent = 'project-ikonka';
      saveLocal();
      renderStepsList(); // aby sa ikonka ukázala aj v menu vľavo
    }catch(err){ alert('Upload ikonky zlyhal: '+err.message); }
  });
  metaCover.addEventListener('change', async (e)=>{
    const file = e.target.files?.[0]; if(!file) return;
    try{
      const path = await uploadImage(file, 'cover');
      meta.cover_path = path;
      metaCoverPreview.style.backgroundImage = `url('${STATIC_BASE}${path}')`;
      metaCoverPathLabel.textContent = 'cover';
      saveLocal();
    }catch(err){ alert('Upload coveru zlyhal: '+err.message); }
  });

  // binds
  btnAddStep.onclick = newStep;
  btnApplyStep.onclick = applyStepForm;
  btnClearMarks.onclick = ()=>{ stepAdded.value=''; renderCodePreview(); if(current>=0&&steps[current]){ steps[current].added=[]; saveLocal(); } };
  btnCopyInline.onclick = ()=>{ navigator.clipboard.writeText(stepCode.value||''); const old=btnCopyInline.textContent; btnCopyInline.textContent='Skopírované ✓'; setTimeout(()=> btnCopyInline.textContent=old, 900); };
  btnAddBullet.onclick = ()=> addBulletRow('');
  btnAddCheck.onclick = ()=> addCheckRow('');
  stepCode.addEventListener('input', renderCodePreview);
  stepFile.addEventListener('input', ()=>{ previewFileLabel.textContent = stepFile.value || '—'; });

  // highlight ikonky
  document.getElementById('hlAssignment').onclick = ()=> toggleHighlight(metaAssignment);
  document.getElementById('hlExplain').onclick    = ()=> toggleHighlight(stepExplain);
  document.getElementById('hlHint').onclick       = ()=> toggleHighlight(stepHint);

  $('#btnStepUp').onclick=()=>{ if(current>0){ const t=steps[current-1]; steps[current-1]=steps[current]; steps[current]=t; current--; saveLocal(); renderStepsList(); renderStepEditor(); } };
  $('#btnStepDown').onclick=()=>{ if(current<steps.length-1){ const t=steps[current+1]; steps[current+1]=steps[current]; steps[current]=t; current++; saveLocal(); renderStepsList(); renderStepEditor(); } };
  $('#btnStepDelete').onclick=()=>{ if(current>=0 && confirm('Vymazať tento krok?')){ steps.splice(current,1); current=Math.min(current,steps.length-1); saveLocal(); if(current===-1){ selectMeta(); } else { renderStepsList(); renderStepEditor(); } } };

  // PREVIEW (bez DB)
  btnPublish.addEventListener('click', async () => {
    if (typeof updateMeta === 'function') updateMeta();
    if (typeof applyStepForm === 'function' && typeof current === 'number' && current >= 0) applyStepForm();

    const payload = { meta, steps };

    try {
      const res = await fetch("{{ url_for('projekt_publish') }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(() => ({}));
      if (!res.ok || data.ok === false) throw new Error(data.error || 'Publish zlyhal.');

      // po úspechu choď rovno na public detail
      window.location.href = "{{ url_for('projekt_public', project_id=0) }}".replace('0', data.project_id);
    } catch (err) {
      alert(err.message || 'Nepodarilo sa publikovať projekt.');
    }
  });

  // init
  (function init(){
    loadLocal();
    renderMeta();
    if(!steps.length){ renderStepsList(); selectMeta(); }
    else { renderStepsList(); (current===-1?selectMeta():selectStep(current)); }
  })();
})();
</script>
{% endblock %}
